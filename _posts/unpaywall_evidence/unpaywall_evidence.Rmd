---
title: "Open Access Evidence in Unpaywall"
description: |
  Unpaywall has become a primary source to find open access full-texts. We investigated more than 42 million scholarly works contained in Unpaywall that were published between 2008 - 2018 with Google BigQuery and R. Our data analysis revealed various open access location types and large overlaps between them, raising important questions about how to reponsibly re-use Unpaywall data in bibliometric research and open access monitoring.
author:
  - name: Najko Jahn 
    url: https://twitter.com/najkoja
    affiliation: State and University Library Göttingen
    affiliation_url: https://www.sub.uni-goettingen.de/
  - name: Anne Hobert
    affiliation: State and University Library Göttingen
    affiliation_url: https://www.sub.uni-goettingen.de/
date: "`r Sys.Date()`"
creative_commons: CC BY
output: distill::distill_article
draft: true
---

```{r, echo = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = TRUE
)
options(scipen = 999, digits = 2)
knitr::knit_hooks$set(
  inline = function(x) {
    if (is.numeric(x)) {
      return(prettyNum(x, big.mark = ","))
    } else{
      return(x)
    }
  }
)
# libraries
library(tidyverse)
library(DBI)
library(bigrquery)
library(scales)
library(plotly)
# ggplot theme
 sub_theme <- theme_minimal(base_family="Roboto") +
  theme(plot.margin=margin(30,30,30,30)) +
  theme(panel.grid.minor=element_blank()) +
  theme(axis.ticks=element_blank()) +
  theme(panel.grid.major.x=element_blank()) +
  theme(panel.border=element_blank())
```

[Unpaywall](https://unpaywall.org/), developed and maintained by the [team of Impactstory](http://impactstory.org/team), is a non-profit service that finds open access copies of scholarly literature. Providing DOIs, [Unpaywall's REST API](https://unpaywall.org/products/api) not only returns open access full-text links, but also helpful metadata about the open access status of a publication indexed in [Crossref](https://www.crossref.org/). While the API is useful for a limited amount of scholarly works, Unpaywall also provides [database snapshots](https://unpaywall.org/products/snapshot) for large-scale analysis, which many bibliometric databases and open access monitoring activities re-use.

In this blog post, we show how we made use of the Unpaywall data dump together [Google BigQuery](https://cloud.google.com/bigquery/), a cloud-based service that allows fast analysis of large datasets, and how we interfaced BigQuery for our analysis with R. We wanted to know the extent of open access status information in Unpaywall, particularly, how this information can be utilized for bibliometric research. In our case, we intend to match evidence from Unpaywall with the Web of Science in-house database from the [German Competence Center for Bibliometrics](http://www.bibliometrie.info/) to determine factors influencing open access publication activities among German Universities as part of our [BMBF-funded research project OAUNI](https://www.wihoforschung.de/de/oauni-2182.php).

## Setting up Google Big Query

## Unpaywall Overview

To investigate the overall number and proportion of journal articles provided using Unpaywall, we firstly connect to Google BigQuery with using the [DBI interface](https://www.r-dbi.org/) and [bigrquery](https://github.com/r-dbi/bigrquery).


```{r fetch_bq}
#' connect to google bg where we imported the jsonl Unpaywall dump
library(DBI)
library(bigrquery)
con <- dbConnect(
  bigrquery::bigquery(),
  project = "api-project-764811344545",
  dataset = "oadoi_full"
)
```

Our BigQuery project has two table, one containing all records between 2008 - 2012, and another with publications since 2019. When connecting, Google will ask you to login via your web browser or to supply an private access token.

```{r}
upw_08_12 <- tbl(con, "feb_19_mongo_export_2008_2012_full_all_genres")
upw_13_19 <- tbl(con, "feb_19_mongo_export_2013_Feb2019_full_all_genres")
```

The [bigrquery](https://github.com/r-dbi/bigrquery) package allows querying BigQuery tables using SQL or the dplyr syntax. The latter is very convienent when you just started to learn SQL, but feel more experienced in the [tidyverse](https://www.tidyverse.org/). Here's an  example where we obtain the first ten records from 2018, restricting our search to journal articles, the most common publication genre in Unpaywall.

```{r}
upw_13_19 %>%
  filter(year == 2018, genre == "journal-article") %>%
  head()
```

Notice that our schema follow the [Unpaywall data format](https://unpaywall.org/data-format). The column  `oa_locations` is a [list-column](https://jennybc.github.io/purrr-tutorial/ls13_list-columns.html) that contain comprehensive metadata about the OA sources found by Unpaywall.

To start with, we want to retrieve the number and proportion of journal articles with open access fulltext between 2008 and 2018 using the most basic Unpaywall variable `is_oa`, a logical value, which is `TRUE` when at leats one open access fulltext was found.  `collect()` loads the data into a local tibble.

```{r cache=TRUE}
library(tidyverse)
oa_08_12 <- upw_08_12 %>%
  # query and aggregate with dpylr 
  filter(genre == "journal-article") %>%
  group_by(year, is_oa) %>%
  summarise(n = n()) %>% 
  # load the data into a local tibble
  collect()
oa_13_18 <- upw_13_19 %>%
  # query and aggregate with dpylr
  filter(genre == "journal-article", year < 2019) %>%
  group_by(year, is_oa) %>%
  summarise(n = n()) %>% 
  # load the data into a local tibble
  collect()
my_df <- bind_rows(oa_08_12, oa_13_18) %>%
  # calculate proportion per year
  ungroup() %>%
  mutate(year = as.Date(as.character(year), format = "%Y")) %>%
  group_by(year, is_oa) %>%
  summarise(n = sum(n)) %>%
  mutate(prop = n / sum(n))
my_df
```

In total, `r sum(my_df$n)` journal articles published between 2008 - 2018 were included in the Unpaywall. For `r  my_df %>% filter(is_oa == TRUE) %>% .$n %>% sum()` articles, Unpwaywall was able to link a DOI to at least one freely available full-text (`r  my_df %>% filter(is_oa == TRUE) %>% .$n %>% sum() / sum(my_df$n) * 100` %).

Next, let's create a graph that presents the prevalence of open access to journal articles over year. We turn our [ggplot object](https://ggplot2.tidyverse.org/index.html) into an interactive [plotly](https://plot.ly/) chart, a javascript library, using `ggplotly()`.

```{r, layout="l-body-outset", fig.cap="Open Access to Journal Articles according to Unpaywall data. Blue areas represent journal articles with at least one freely available full-text, the gray represent toll-access articles."}
library(scales)
plot_a <- my_df %>%
  # prepare label that we want to present as tooltip
  mutate(`Proportion in %` = round(prop * 100, 2)) %>%
  ggplot(aes(year, n, label = `Proportion in %`)) +
  geom_area(aes(fill = is_oa, group = is_oa),  alpha = 0.8) +
  labs(x = "Year published", y = "Journal Articles",
       title = "Open Access to Journal Articles") +
  scale_fill_manual("Is OA?",
                    values = c("#b3b3b3a0", "#56B4E9")) +
  scale_x_date(date_labels = "%y") +
  scale_y_continuous(labels = scales::number_format(big.mark = " ")) +
  theme_minimal(base_family = "Roboto") +
  theme(plot.margin = margin(30, 30, 30, 30)) +
  theme(panel.grid.minor = element_blank()) +
  theme(axis.ticks = element_blank()) +
  theme(panel.grid.major.x = element_blank()) +
  theme(panel.border = element_blank())
# turn ggplot object into interactive plotly chart
plotly::ggplotly(plot_a, tooltip = c("label", "y")) 
```


While a general growth of journal articles as well open access provision can be observed, there is a considerable decline in the number of journal articles published in 2018,  presumbably because of an indexing lag between Crossref and Unpaywall. The decline in open access full-text availability was even clearer in comparison between 2017 and 2018, suggesting that some open access content is provided after an embargo period.

## Unpaywall OA location types

Using Unpaywall's OA location types allows a more detailled analysis of open access provision. In the following, we explore the variable `host_type`, showing whether Unpaywall found the open access full-text on a publisher website or in a repository. We furthermore want to include articles from fully open access journals that are indexed in [Directory of Open Access Journals (DOAJ)](https://doaj.org/) as indicated by the `journal_is_in_doaj` variable. A a start, we only examine the best open access location per DOI, `ìs_best`, defined by Unpaywall's algorithm that prioritizes publisher-hosted content.

Instead of dplyr, we are now querying BigQuery with SQL. We built and tested the SQL query in the BigQuery web UI. Here are our queries:

```{r}
host_type_08_12_query <- "SELECT year, host_type, journal_is_in_doaj, COUNT(DISTINCT(doi)) AS number_of_articles FROM `oadoi_full.feb_19_mongo_export_2008_2012_full_all_genres`, UNNEST(oa_locations) WHERE genre = 'journal-article' AND is_best = true GROUP BY year, host_type, journal_is_in_doaj"
host_type_13_18_query <- "SELECT year, host_type, journal_is_in_doaj, COUNT(DISTINCT(doi)) AS number_of_articles FROM `oadoi_full.feb_19_mongo_export_2013_Feb2019_full_all_genres`, UNNEST(oa_locations) WHERE genre = 'journal-article' AND year < 2019 AND is_best = true GROUP BY year, host_type, journal_is_in_doaj"
```

Let's call BigQuery:

```{r}
host_type_08_12_query_df <- dbGetQuery(con,host_type_08_12_query) 
host_type_13_18_query_df <- dbGetQuery(con,host_type_13_18_query) 
host_type_df <- bind_rows(host_type_08_12_query_df,host_type_13_18_query_df) %>%
  mutate(host = case_when(journal_is_in_doaj == TRUE ~ "DOAJ-listed Journal",
                          host_type == "publisher" ~ "Other Journals",
                          host_type == "repository" ~ "Repositories only")) %>%
  mutate(year = as.Date(as.character(year), format = "%Y")) 
host_type_df
```

As to explore our data, we follow [Claus Wilke excellent book "Fundamentals of Data Visualization"](https://serialmentor.com/dataviz/) and [visualise our proportions separately as parts of the total](https://serialmentor.com/dataviz/visualizing-proportions.html#visualizing-proportions-separately-as-parts-of-the-total). Again, our final ggplot object will be transformed to an interactive plotly chart.

```{r, layout="l-body-outset", fig.cap='Open Access to journal articles by  open access hosting location. The colored bars represent the number of open access articles per host ("DOAJ-listed Journal", "Other Journals", "Repositories only"), the gray bar the total number of journal articles indexed in Crossref where Unpaywall was able to identify at least one open access full-text.'}
# calculate all oa articles per year
all_articles <- host_type_df %>%
  ungroup() %>%
  group_by(year) %>%
  summarise(number_of_articles = sum(number_of_articles))

plot_b <-
  ggplot(host_type_df, aes(x = year, y = number_of_articles)) +
  geom_bar(
    data = all_articles,
    aes(fill = "All OA Articles"),
    color = "transparent",
    stat = "identity"
  ) +
  geom_bar(aes(fill = "by Host"), color = "transparent", stat = "identity") +
  facet_wrap( ~ host, nrow = 1) +
  scale_fill_manual(values = c("#b3b3b3a0", "#56B4E9"), name = "") +
  labs(x = "Year", y = "OA Articles (Total)") +
  theme(legend.position = "top",
        legend.justification = "right") +
  scale_x_date(date_labels = "%y") +
  scale_y_continuous(labels = scales::number_format(big.mark = " ")) +
  theme_minimal(base_family = "Roboto") +
  theme(plot.margin = margin(30, 30, 30, 30)) +
  theme(panel.grid.minor = element_blank()) +
  theme(axis.ticks = element_blank()) +
  theme(panel.grid.major.x = element_blank()) +
  theme(panel.border = element_blank())
# turn ggplot object into interactive plotly chart
plotly::ggplotly(plot_b, tooltip = c("y")) 
```

The figure shows that most publisher-provided open access links were obtained from journals that were not indexed in the DOAJ (`r host_type_df %>% filter(host == "Other Journals") %>% .$number_of_articles %>% sum()` articles, representing `r host_type_df %>% filter(host == "Other Journals") %>% .$number_of_articles %>% sum() / host_type_df %>% .$number_of_articles %>% sum() * 100` % of all journal articles with openly available full-text identified by Unpaywall), raising important questions about the other ways publisher made articles openly available. 

Currently, we are discussing the following explanations:

1. a journal did not meet DOAJ indexing criteria, but is indexed by Crossref. Examples include articles from so-called "predatory publishers" like OMICS or collections of procedia published as journals(e.g. [Elsevier's Procedia journals](https://www.elsevier.com/books-and-journals/procedia). 

2. Toll-access journals made specific articles openly available immediately upon publication ("hybrid open access"). 

3. The category "Other Journals" accounts for delayed open access journals where full issues were made openly available after an embargo period. Example includes the publisher Elsevier, which [lists 118 journals](https://www.elsevier.com/about/open-science/open-access/open-archive) that provide free access after a certain period of time, ranging between six and 48 months. The sharp decline in 2018 suggests that the proportion of delayed open access provided by publishers should not be underestimated.




## Unpaywall OA evidence types

## Discussion and Conclusion


